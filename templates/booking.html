{% extends "index.html" %}
{% load static %}
{% block title %}Home{% endblock %}


{% block content %}
<!-- =======Style======== -->
<link rel="stylesheet" href="{% static 'style/css/booking.css' %}" />


<section class="section-one">
    <div class="booking-container">
        <div id="loader" class="loader-container">
            <div class="loader"></div>
        </div>    
        <form class="booking-form" id="appointmentForm" method="POST">
            {% csrf_token %}
            <h1>Book Your Appointment</h1>
    
            <div class="form-group">
                <label>Select Service</label>
                <div class="service-options">
                    <div class="service-option" data-value="Haircut" data-duration="60" data-price="65">
                        <h3>Haircut</h3>
                        <p>20 min | ₹120</p>
                    </div>
                    <div class="service-option" data-value="Hair Color" data-duration="120" data-price="150">
                        <h3>Hair Color</h3>
                        <p>1 Hr | ₹100</p>
                    </div>
                    <div class="service-option" data-value="Beard Dressing" data-duration="90" data-price="120">
                        <h3>Beard Dressing</h3>
                        <p>15 min | ₹100</p>
                    </div>
                    <div class="service-option" data-value="Shaving" data-duration="30" data-price="45">
                        <h3>Shaving</h3>
                        <p>10 min | ₹80</p>
                    </div>
                </div>
                <input type="hidden" id="selectedService" name="service">
            </div>
    
            <div class="form-group">
                <label>Select Date</label>
                <input type="date" id="appointmentDate" name="date" required>
            </div>
    
            <div class="form-group">
                <label>Available Time Slots</label>
                <div class="filter-buttons">
                    <button class="filter-btn" onclick="filterSlots('morning')">Morning</button>
                    <button class="filter-btn" onclick="filterSlots('afternoon')">Afternoon</button>
                    <button class="filter-btn"class="filter-btn" onclick="filterSlots('evening')">Evening</button>
                    <button class="filter-btn" onclick="filterSlots('all')">Show All</button>
                </div>
                <div class="time-slots">
                    <div class="time-slot" data-time="09:00 AM">9:00 AM</div>
                    <div class="time-slot" data-time="09:15 AM">9:15 AM</div>
                    <div class="time-slot" data-time="09:30 AM">9:30 AM</div>
                    <div class="time-slot" data-time="10:00 AM">10:00 AM</div>
                    <div class="time-slot" data-time="10:15 AM">10:15 AM</div>
                    <div class="time-slot" data-time="10:30 AM">10:30 AM</div>
                    <div class="time-slot" data-time="11:15 AM">11:15 AM</div>
                    <div class="time-slot" data-time="11:45 AM">11:45 AM</div>
                    <div class="time-slot" data-time="12:00 PM">12:00 PM</div>
                    <div class="time-slot" data-time="12:15 PM">12:15 PM</div>
                    <div class="time-slot" data-time="12:30 PM">12:30 PM</div>
                    <div class="time-slot" data-time="01:00 PM">1:00 PM</div>
                    <div class="time-slot" data-time="01:15 PM">1:15 PM</div>
                    <div class="time-slot" data-time="01:30 PM">1:30 PM</div>
                    <div class="time-slot" data-time="02:00 PM">2:00 PM</div>
                    <div class="time-slot" data-time="02:15 PM">2:15 PM</div>
                    <div class="time-slot" data-time="02:30 PM">2:30 PM</div>
                    <div class="time-slot" data-time="03:00 PM">3:00 PM</div>
                    <div class="time-slot" data-time="03:15 PM">3:15 PM</div>
                    <div class="time-slot" data-time="03:30 PM">3:30 PM</div>
                    <div class="time-slot" data-time="04:00 PM">4:00 PM</div>
                    <div class="time-slot" data-time="04:15 PM">4:15 PM</div>
                    <div class="time-slot" data-time="04:30 PM">4:30 PM</div>
                    <div class="time-slot" data-time="05:00 PM">5:00 PM</div>
                </div>
                <input type="hidden" id="selectedTime" name="time">
            </div>
            <div class="form-form">
                <div class="form-group">
                    <label>Your Name</label>
                    <input type="text" name="name" required placeholder="Enter your full name">
                </div>
        
                <div class="form-group">
                    <label>Phone Number</label>
                    <input type="tel" name="phone" required placeholder="Enter your phone number">
                </div>
        
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" name="email" required placeholder="Enter your email">
                        <small style="display: block; font-size:10px; margin-top: 5px; color: #666;">
                            *Please enter your valid email to receive booking confirmation.
                        </small>
                    </div>
        
                <div class="form-group">
                    <label>Special Requests</label>
                    <input type="text" name="special_requests" placeholder="Any special requests or notes">
                </div>
            </div>
    
            <button type="submit" class="submit-btn">Book Appointment</button>
        </form>
    </div>
</section>


<script>
    // Service selection
    const serviceOptions = document.querySelectorAll('.service-option');
    serviceOptions.forEach(option => {
        option.addEventListener('click', () => {
            serviceOptions.forEach(opt => opt.classList.remove('selected'));
            option.classList.add('selected');
            document.getElementById('selectedService').value = option.getAttribute('data-value');
        });
    });

    // Function to convert time from 12-hour format (e.g., "9:00 AM") to 24-hour format ("09:00")
    function convertTo24HourFormat(timeStr) {
        const [time, modifier] = timeStr.split(" ");
        let [hours, minutes] = time.split(":");

        if (modifier === "PM" && hours !== "12") {
            hours = parseInt(hours) + 12;
        }
        if (modifier === "AM" && hours === "12") {
            hours = "00";
        }
        return `${hours}:${minutes}`;
    }

    // Time slot selection
    const timeSlots = document.querySelectorAll('.time-slot');
    timeSlots.forEach(slot => {
        slot.addEventListener('click', () => {
            timeSlots.forEach(s => s.classList.remove('selected'));
            slot.classList.add('selected');
            // Convert to 24-hour format before storing
            document.getElementById('selectedTime').value = convertTo24HourFormat(slot.innerText);
        });
    });

    // Time filter function
    function filterSlots(type) {
        const slots = document.querySelectorAll('.time-slot');
        slots.forEach(slot => {
            const timeText = slot.getAttribute('data-time');
            const [hour, minute, period] = timeText.match(/\d+|AM|PM/g);
            let hourInt = parseInt(hour);
            if (period === "PM" && hourInt !== 12) hourInt += 12;
            slot.style.display = "block"; // Reset all slots
            if (type === "morning" && period !== "AM") {
                slot.style.display = "none";
            } else if (type === "afternoon" && (period !== "PM" || hourInt >= 17)) {
                slot.style.display = "none";
            } else if (type === "evening" && (hourInt < 17)) {
                slot.style.display = "none";
            }
        });
    }

    // Set minimum date to today
    const dateInput = document.getElementById('appointmentDate');
    const today = new Date().toISOString().split('T')[0];
    dateInput.min = today;

    // Single combined form submission handler
    document.getElementById('appointmentForm').addEventListener('submit', async (e) => {
        e.preventDefault();

        const emailInput = document.querySelector('input[name="email"]');
        const email = emailInput.value.trim();

        if (!validateEmail(email)) {
            alert("Please enter a valid email address.");
            return; // Stop form submission
        }

        const submitButton = document.querySelector('.submit-btn');
        const loader = document.getElementById('loader');

        submitButton.disabled = true;
        loader.style.display = 'flex'; // Show loader

        const formData = new FormData(e.target);

        try {
            const response = await fetch("{% url 'booking' %}", {
                method: 'POST',
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                },
                body: formData,
            });

            if (response.ok) {
                const data = await response.json();
                alert("Booking successful! A confirmation email has been sent.");
                window.location.href = data.redirect;
            } else {
                const errorData = await response.json();
                alert("Error: " + JSON.stringify(errorData.errors));
            }
        } catch (error) {
            alert("An error occurred while submitting the form: " + error);
        } finally {
            submitButton.disabled = false;
            loader.style.display = 'none'; // Hide loader
        }
    });

    // JavaScript function to validate email
    function validateEmail(email) {
        const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        return emailPattern.test(email);
    }   

// loader script
document.getElementById('appointmentForm').addEventListener('submit', async (e) => {
    e.preventDefault();

    const emailInput = document.querySelector('input[name="email"]');
    const email = emailInput.value.trim();

    if (!validateEmail(email)) {
        alert("Please enter a valid email address.");
        return; // Stop form submission
    }

    const submitButton = document.querySelector('.submit-btn');
    const loader = document.getElementById('loader');

    submitButton.disabled = true;
    loader.style.display = 'flex'; // Show loader

    const formData = new FormData(e.target);

    try {
        const response = await fetch("{% url 'booking' %}", {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            },
            body: formData,
        });

        if (response.ok) {
            const data = await response.json();
            alert("Booking successful! A confirmation email has been sent.");
            window.location.href = data.redirect;
        } else {
            const errorData = await response.json();
            alert("Error: " + JSON.stringify(errorData.errors));
        }
    } catch (error) {
        alert("An error occurred while submitting the form: " + error);
    } finally {
        submitButton.disabled = false;
        loader.style.display = 'none'; // Hide loader
    }
});

</script>



{% endblock %}