{% extends "index.html" %}
{% load static %}
{% block title %}Home{% endblock %}


{% block content %}
<!-- =======Style======== -->
<link rel="stylesheet" href="{% static 'style/css/booking.css' %}" />



<div class="booking-container">
    <form class="booking-form" id="appointmentForm" method="POST">
        {% csrf_token %}
        <h1>Book Your Appointment</h1>

        <div class="form-group">
            <label>Select Service</label>
            <div class="service-options">
                <div class="service-option" data-value="Haircut" data-duration="60" data-price="65">
                    <h3>Haircut</h3>
                    <p>60 min | ₹90</p>
                </div>
                <div class="service-option" data-value="Hair Color" data-duration="120" data-price="150">
                    <h3>Hair Color</h3>
                    <p>120 min | ₹150</p>
                </div>
                <!-- <div class="service-option" data-value="Spa Treatment" data-duration="90" data-price="120">
                    <h3>Spa Treatment</h3>
                    <p>90 min | $120</p>
                </div> -->
                <div class="service-option" data-value="Styling" data-duration="30" data-price="45">
                    <h3>Styling</h3>
                    <p>30 min | ₹45</p>
                </div>
            </div>
            <input type="hidden" id="selectedService" name="service">
        </div>

        <div class="form-group">
            <label>Select Date</label>
            <input type="date" id="appointmentDate" name="date" required>
        </div>

        <div class="form-group">
            <label>Available Time Slots</label>
            <div class="time-slots">
                <div class="time-slot">9:00 AM</div>
                <div class="time-slot">10:00 AM</div>
                <div class="time-slot">11:00 AM</div>
                <div class="time-slot">1:00 PM</div>
                <div class="time-slot">2:00 PM</div>
                <div class="time-slot">3:00 PM</div>
                <div class="time-slot">4:00 PM</div>
                <div class="time-slot">5:00 PM</div>
            </div>
            <input type="hidden" id="selectedTime" name="time">
        </div>

        <div class="form-group">
            <label>Your Name</label>
            <input type="text" name="name" required placeholder="Enter your full name">
        </div>

        <div class="form-group">
            <label>Phone Number</label>
            <input type="tel" name="phone" required placeholder="Enter your phone number">
        </div>

        <div class="form-group">
            <label>Email</label>
            <input type="email" name="email" required placeholder="Enter your email">
        </div>

        <div class="form-group">
            <label>Special Requests</label>
            <input type="text" name="special_requests" placeholder="Any special requests or notes">
        </div>

        <button type="submit" class="submit-btn">Book Appointment</button>
    </form>
</div>

<script>
    // Service selection
    const serviceOptions = document.querySelectorAll('.service-option');
    serviceOptions.forEach(option => {
        option.addEventListener('click', () => {
            serviceOptions.forEach(opt => opt.classList.remove('selected'));
            option.classList.add('selected');
            document.getElementById('selectedService').value = option.getAttribute('data-value');
        });
    });

    // Function to convert time from 12-hour format (e.g., "9:00 AM") to 24-hour format ("09:00")
    function convertTo24HourFormat(timeStr) {
        const [time, modifier] = timeStr.split(" ");
        let [hours, minutes] = time.split(":");

        if (modifier === "PM" && hours !== "12") {
            hours = parseInt(hours) + 12;
        }
        if (modifier === "AM" && hours === "12") {
            hours = "00";
        }
        return `${hours}:${minutes}`;
    }

    // Time slot selection
    const timeSlots = document.querySelectorAll('.time-slot');
    timeSlots.forEach(slot => {
        slot.addEventListener('click', () => {
            timeSlots.forEach(s => s.classList.remove('selected'));
            slot.classList.add('selected');

            // Convert to 24-hour format before storing
            document.getElementById('selectedTime').value = convertTo24HourFormat(slot.innerText);
        });
    });

    // Set minimum date to today
    const dateInput = document.getElementById('appointmentDate');
    const today = new Date().toISOString().split('T')[0];
    dateInput.min = today;

    // Form submission
    document.getElementById('appointmentForm').addEventListener('submit', async (e) => {
    e.preventDefault();

    const emailInput = document.querySelector('input[name="email"]');
    const email = emailInput.value.trim();

    if (!validateEmail(email)) {
        alert("Please enter a valid email address.");
        return; // Stop form submission
    }

    const submitButton = document.querySelector('.submit-btn');
    submitButton.disabled = true;

    const formData = new FormData(e.target);

    try {
        const response = await fetch("{% url 'booking' %}", {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            },
            body: formData,
        });

        if (response.ok) {
            const data = await response.json();
            alert("Booking successful! A confirmation email has been sent.");
            window.location.href = data.redirect;
        } else {
            const errorData = await response.json();
            alert("Error: " + JSON.stringify(errorData.errors));
        }
    } catch (error) {
        alert("An error occurred while submitting the form: " + error);
    } finally {
        submitButton.disabled = false;
    }
});

// JavaScript function to validate email
function validateEmail(email) {
    const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    return emailPattern.test(email);
}

    
</script>



{% endblock %}